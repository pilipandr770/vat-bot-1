# Pentesting Module Integration - Code Snippets

Copy-paste ready code snippets for integrating the pentesting module.

---

## 1Ô∏è‚É£ application.py - Blueprint Registration

**Location**: Around line 140 (find other `register_blueprint` calls)

```python
# ============================================================================
# EXISTING BLUEPRINTS (already in application.py)
# ============================================================================

from auth.routes import auth_bp
app.register_blueprint(auth_bp, url_prefix='/auth')

from payments.routes import payments_bp
app.register_blueprint(payments_bp, url_prefix='/payments')

# ... other blueprints ...

from programmatic.routes import programmatic_bp
app.register_blueprint(programmatic_bp)

# ============================================================================
# ADD THIS NEW BLUEPRINT (Copy-paste below)
# ============================================================================

# Register Pentesting blueprint
from app.pentesting.routes import pentesting
app.register_blueprint(pentesting, url_prefix='/api/pentesting')

# ============================================================================
# CONTINUE WITH EXISTING CODE
# ============================================================================

# Init scheduler (only in production/when not in debug reload)
if not app.debug or os.environ.get('WERKZEUG_RUN_MAIN') == 'true':
    init_scheduler()
    # ... rest of scheduling code ...
```

---

## 2Ô∏è‚É£ application.py - Add Scanner Route

**Location**: After `@app.route('/dashboard')` function (around line 180)

```python
@app.route('/dashboard')
@login_required
def dashboard():
    """Main verification interface for authenticated users."""
    # ... existing dashboard code ...
    pass


# ADD THIS NEW ROUTE (Copy-paste below)
@app.route('/pentesting-scanner')
@login_required
def pentesting_scanner():
    """Serve website security scanner UI."""
    return render_template('pentesting/scanner.html')


# ============================================================================
# Continue with existing routes...
# ============================================================================
```

---

## 3Ô∏è‚É£ Navigation Template - Add Link

**Location**: `templates/base.html` or `templates/nav.html` (in navigation menu)

```html
<!-- Existing navigation items -->
<nav class="navbar">
    <a href="{{ url_for('landing') }}">Home</a>
    
    {% if current_user.is_authenticated %}
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        
        <!-- ADD THIS NEW LINK (Copy-paste below) -->
        {% if current_user.is_admin or (current_user.active_subscription and current_user.active_subscription.plan in ['pro', 'enterprise']) %}
            <a href="{{ url_for('pentesting_scanner') }}" class="nav-link">
                üõ°Ô∏è Security Scanner
            </a>
        {% endif %}
        
        <a href="{{ url_for('auth.logout') }}">Logout</a>
    {% endif %}
</nav>
```

---

## 4Ô∏è‚É£ Pricing Page - Feature List Update

**Location**: `templates/pricing.html`

```html
<!-- PRO Plan Features (add scanner) -->
<div class="plan-pro">
    <h3>Professional Plan - ‚Ç¨49.99/month</h3>
    <ul class="features">
        <li>‚úÖ 200 Verifications per Month</li>
        <li>‚úÖ All Validation Services</li>
        
        <!-- ADD THIS NEW FEATURE -->
        <li>‚úÖ Website Security Scanner (50 scans/day)</li>
        
        <li>‚úÖ Detailed Reports</li>
        <li>‚úÖ Priority Support</li>
    </ul>
</div>

<!-- ENTERPRISE Plan Features (add scanner) -->
<div class="plan-enterprise">
    <h3>Enterprise Plan - ‚Ç¨199.99/month</h3>
    <ul class="features">
        <li>‚úÖ Unlimited Verifications</li>
        
        <!-- ADD THIS NEW FEATURE -->
        <li>‚úÖ Unlimited Website Security Scans</li>
        
        <li>‚úÖ White-Label Solution</li>
        <li>‚úÖ API Access</li>
        <li>‚úÖ Custom Integration</li>
        <li>‚úÖ 24/7 Premium Support</li>
    </ul>
</div>
```

---

## 5Ô∏è‚É£ Admin Dashboard - Add Statistics

**Location**: `templates/admin/dashboard.html` or new `pentesting-stats.html`

```html
<!-- Add this card to admin dashboard -->
<div class="widget stats-card">
    <h3>üõ°Ô∏è Security Scanner</h3>
    
    <div class="stat-item">
        <label>Total Scans:</label>
        <span id="total-scans">Loading...</span>
    </div>
    
    <div class="stat-item">
        <label>Scans Today:</label>
        <span id="scans-today">Loading...</span>
    </div>
    
    <div class="stat-item">
        <label>Average Score:</label>
        <span id="avg-score">Loading...</span>
    </div>
    
    <div class="stat-item">
        <label>Critical Issues:</label>
        <span id="critical-count">Loading...</span>
    </div>
</div>

<script>
// Load statistics
fetch('/api/admin/pentesting/stats')
    .then(r => r.json())
    .then(data => {
        document.getElementById('total-scans').textContent = data.total_scans;
        document.getElementById('scans-today').textContent = data.scans_today;
        document.getElementById('avg-score').textContent = data.average_score.toFixed(1);
        document.getElementById('critical-count').textContent = data.critical_count;
    })
    .catch(e => console.error('Failed to load stats:', e));
</script>
```

---

## 6Ô∏è‚É£ Dashboard Widget - Add Scanner Preview

**Location**: `templates/dashboard.html` (in main dashboard)

```html
<!-- Add this widget to dashboard -->
<div class="widget security-scanner-widget">
    <div class="widget-header">
        <h3>üõ°Ô∏è Website Security Checker</h3>
        <p>Check your website for vulnerabilities</p>
    </div>
    
    <div class="widget-body">
        <p class="subtitle">
            Identify security issues before hackers do
        </p>
        
        <a href="{{ url_for('pentesting_scanner') }}" class="btn btn-primary">
            Start Security Scan ‚Üí
        </a>
    </div>
</div>

<style>
.security-scanner-widget {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.security-scanner-widget .subtitle {
    opacity: 0.9;
    margin: 10px 0 15px 0;
}

.security-scanner-widget .btn {
    background: white;
    color: #667eea;
    font-weight: 600;
    padding: 10px 20px;
}
</style>
```

---

## 7Ô∏è‚É£ Database Migration - Verify

**Location**: `migrations/versions/[timestamp]_add_pentesting_module.py`

```bash
# The migration should already be created when you run:
flask db migrate -m "Add pentesting module"

# But if you need to view or verify it exists:
cat migrations/versions/[latest_file]

# Should contain:
# - CREATE TABLE pentesting_logs
# - CREATE TABLE pentesting_quotas
```

---

## 8Ô∏è‚É£ Admin API - Add Statistics Endpoint

**Location**: Create new file `admin/pentesting_analytics.py`

```python
"""
Admin analytics for pentesting module.
Add to admin routes.
"""

from flask import Blueprint, jsonify
from flask_login import login_required, current_user
from app import db
from app.pentesting.models import PentestingLog
from sqlalchemy import func
from datetime import datetime, timedelta

pentesting_analytics = Blueprint('pentesting_analytics', __name__, url_prefix='/api/admin/pentesting')


@pentesting_analytics.before_request
def check_admin():
    """Ensure user is admin."""
    if not current_user.is_authenticated or not current_user.is_admin:
        return jsonify({'error': 'Forbidden'}), 403


@pentesting_analytics.route('/stats', methods=['GET'])
def get_stats():
    """Get pentesting module statistics."""
    today = datetime.utcnow() - timedelta(days=1)
    
    total_scans = PentestingLog.query.count()
    scans_today = PentestingLog.query.filter(PentestingLog.created_at >= today).count()
    avg_score = db.session.query(func.avg(PentestingLog.security_score)).scalar() or 0
    critical_count = PentestingLog.query.filter(PentestingLog.security_score < 40).count()
    
    return jsonify({
        'total_scans': total_scans,
        'scans_today': scans_today,
        'average_score': float(avg_score),
        'critical_count': critical_count,
        'timestamp': datetime.utcnow().isoformat()
    })


@pentesting_analytics.route('/usage', methods=['GET'])
def get_usage_by_plan():
    """Get usage statistics by subscription plan."""
    from app.auth.models import User, Subscription
    
    # Group scans by user subscription plan
    usage = db.session.query(
        Subscription.plan,
        func.count(PentestingLog.id).label('scan_count'),
        func.avg(PentestingLog.security_score).label('avg_score')
    ).outerjoin(
        User, User.id == PentestingLog.user_id
    ).outerjoin(
        Subscription, Subscription.user_id == User.id
    ).group_by(Subscription.plan).all()
    
    return jsonify({
        'by_plan': [
            {
                'plan': plan or 'free',
                'scans': count,
                'avg_score': float(score) if score else 0
            }
            for plan, count, score in usage
        ]
    })


# In admin/routes.py, add:
# from admin.pentesting_analytics import pentesting_analytics
# app.register_blueprint(pentesting_analytics)
```

---

## 9Ô∏è‚É£ Email Notification - New Feature Announcement

**Location**: Create email template `templates/email/pentesting_announcement.html`

```html
<h2>üõ°Ô∏è New Feature: Website Security Scanner</h2>

<p>Hi {{ user_name }},</p>

<p>We're excited to announce a new security feature exclusively for our PRO and ENTERPRISE users!</p>

<h3>Website Security Scanner</h3>
<p>
    Check your website for common security vulnerabilities in seconds:
</p>

<ul>
    <li>SSL/TLS Configuration</li>
    <li>Security Headers</li>
    <li>SQL Injection Vulnerabilities</li>
    <li>XSS Attacks</li>
    <li>CSRF Protection</li>
    <li>Open Ports</li>
    <li>DNSSEC Validation</li>
</ul>

<p>
    Plus, our AI analyzes the results and provides easy-to-understand 
    explanations and recommendations.
</p>

<p>
    <a href="https://yourapp.com/pentesting-scanner" class="btn btn-primary">
        Start Your First Security Scan ‚Üí
    </a>
</p>

<p>Best regards,<br>The {{ app_name }} Team</p>
```

Send via:
```python
from flask_mail import Message

msg = Message(
    subject='üõ°Ô∏è New: Website Security Scanner',
    recipients=[pro_user.email],
    html=render_template('email/pentesting_announcement.html', 
                        user_name=pro_user.name, app_name='VAT-Bot')
)
mail.send(msg)
```

---

## üîü Documentation - Update Main README

**Location**: `README.md`

```markdown
## Features

### Verification Services
- Company VAT Verification
- SEPA Compliance Checks
- Fraud Prevention
- **NEW: Website Security Scanner** (PRO & ENTERPRISE)

### Website Security Scanner (NEW!)

Available for PRO and ENTERPRISE users.

Features:
- 7 security checks (SSL/TLS, headers, SQL injection, XSS, CSRF, ports, DNSSEC)
- AI-powered analysis with explanations
- Up to 50 scans/day (PRO) or unlimited (ENTERPRISE)
- Export reports

[Learn more ‚Üí](PENTESTING_QUICK_START.md)

## API Documentation

### Website Security Scanner

```bash
# Quick scan
POST /api/pentesting/quick-scan
{
  "url": "example.com"
}

# Full scan with AI analysis
POST /api/pentesting/scan
{
  "url": "example.com",
  "include_ai_analysis": true,
  "language": "de"
}
```

[Full API docs ‚Üí](PENTESTING_INTEGRATION.md)
```

---

## Summary

You now have all copy-paste ready code snippets:

1. ‚úÖ Blueprint registration
2. ‚úÖ Route registration
3. ‚úÖ Navigation link
4. ‚úÖ Pricing page update
5. ‚úÖ Admin dashboard widget
6. ‚úÖ Dashboard preview widget
7. ‚úÖ Database migration
8. ‚úÖ Admin analytics endpoint
9. ‚úÖ Email notification
10. ‚úÖ README update

**Next Step**: `git add . && git commit -m "..." && git push origin main`

Deploy time: **2-3 minutes on Render** ‚úÖ
