# üõ°Ô∏è VirusTotal API Setup - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

## ‚úÖ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ:

1. **–ö–æ–¥ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω:**
   - ‚úÖ `app/mailguard/attachment_scanner.py` - –º–æ–¥—É–ª—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - ‚úÖ Gmail connector –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
   - ‚úÖ –ú–æ–¥–µ–ª—å `MailMessage` –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
   - ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

2. **Render –Ω–∞—Å—Ç—Ä–æ–µ–Ω:**
   - ‚úÖ `flask db upgrade` –≤ buildCommand (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
   - ‚úÖ `VIRUSTOTAL_API_KEY` –¥–æ–±–∞–≤–ª–µ–Ω –≤ render.yml

3. **–î–µ–ø–ª–æ–π –≥–æ—Ç–æ–≤:**
   - ‚úÖ –ö–æ–¥ –∑–∞–ø—É—à–µ–Ω –Ω–∞ GitHub
   - ‚úÖ Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

---

## üöÄ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å:

### –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å VirusTotal API Key (–ë–ï–°–ü–õ–ê–¢–ù–û)

1. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ VirusTotal:**
   - –ü–µ—Ä–µ–π—Ç–∏: https://www.virustotal.com/gui/join-us
   - –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç

2. **–ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á:**
   - –ü–µ—Ä–µ–π—Ç–∏: https://www.virustotal.com/gui/my-apikey
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á (–≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫: `a1b2c3d4e5f6...`)

3. **Free tier –ª–∏–º–∏—Ç—ã:**
   - ‚úÖ 500 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å
   - ‚úÖ 4 –∑–∞–ø—Ä–æ—Å–∞ –≤ –º–∏–Ω—É—Ç—É
   - ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 10-20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å email automation

---

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á –≤ Render

1. **–û—Ç–∫—Ä—ã—Ç—å Render Dashboard:**
   - –ü–µ—Ä–µ–π—Ç–∏: https://dashboard.render.com
   - –í—ã–±—Ä–∞—Ç—å —Å–µ—Ä–≤–∏—Å `vat-verification-platform`

2. **–î–æ–±–∞–≤–∏—Ç—å environment variable:**
   - –í–∫–ª–∞–¥–∫–∞ **Environment**
   - –ù–∞–∂–∞—Ç—å **Add Environment Variable**
   - **Key:** `VIRUSTOTAL_API_KEY`
   - **Value:** –≤–∞—à API –∫–ª—é—á –∏–∑ —à–∞–≥–∞ 1
   - –ù–∞–∂–∞—Ç—å **Save Changes**

3. **–î–æ–∂–¥–∞—Ç—å—Å—è —Ä–µ–¥–µ–ø–ª–æ—è:**
   - Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å–µ—Ä–≤–∏—Å
   - –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - Attachment scanning –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ—Ç–∫—Ä–æ–π—Ç–µ **Render Shell** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
flask db current
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
e8a4b92c5d11 (head)
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–æ–≤—ã–µ –ø–æ–ª—è —Å–æ–∑–¥–∞–Ω—ã:
```bash
psql $DATABASE_URL -c "\d mail_messages" | grep attachments
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
attachments_json        | text
has_attachments         | boolean
has_dangerous_attachments | boolean
is_quarantined         | boolean
quarantine_reason      | character varying(500)
```

---

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ VirusTotal API

–í Render Shell:

```python
python
>>> from app.mailguard.attachment_scanner import AttachmentScanner
>>> from flask import current_app
>>> with app.app_context():
...     scanner = AttachmentScanner()
...     print(f"API Key configured: {bool(scanner.vt_api_key)}")
...     print(f"API Key: {scanner.vt_api_key[:10]}...")
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
API Key configured: True
API Key: a1b2c3d4e5...
```

---

### –¢–µ—Å—Ç 3: –†–µ–∞–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ü–æ–¥–∫–ª—é—á–∏—Ç—å Gmail –∞–∫–∫–∞—É–Ω—Ç:**
   - –ü–µ—Ä–µ–π—Ç–∏: https://vat-bot-1.onrender.com/mailguard/accounts
   - –ù–∞–∂–∞—Ç—å "–î–æ–±–∞–≤–∏—Ç—å Gmail"
   - –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è

2. **–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ:**
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–µ–±–µ email —Å –≤–ª–æ–∂–µ–Ω–∏–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, PDF)
   - MailGuard –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç –ø–∏—Å—å–º–æ
   - Attachment –±—É–¥–µ—Ç –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª–æ–≥–∞—Ö:**

–í Render ‚Üí Logs –∏—â–∏—Ç–µ:
```
Starting scan for attachment: test.pdf (application/pdf)
Decoded test.pdf: 12345 bytes
SHA256 hash for test.pdf: abc123...
VirusTotal hash found for test.pdf: 0/70
Scan complete for test.pdf: risk_level=safe, is_safe=True
```

---

## üìä –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

### –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ email —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏:

```
1. Gmail API ‚Üí Fetch email
2. AttachmentScanner ‚Üí Decode base64 (–≤ –ø–∞–º—è—Ç–∏)
3. SHA256 hash calculation
4. VirusTotal check by hash (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω)
5. If not found ‚Üí Upload to VirusTotal (30-60 —Å–µ–∫)
6. Save to MailMessage.attachments_json
7. If dangerous ‚Üí Auto-quarantine
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:

- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ–∞–π–ª—ã**: –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å"
- ‚ö†Ô∏è **–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ + –¥–µ—Ç–∞–ª–∏
- üö® **–û–ø–∞—Å–Ω—ã–µ**: –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ + –ø—Ä–∏—á–∏–Ω–∞

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API:

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–≤–æ—Ç—É VirusTotal:

```bash
curl -H "x-apikey: YOUR_API_KEY" https://www.virustotal.com/api/v3/users/YOUR_USER_ID/overall_quotas
```

### –ò–ª–∏ –≤ Dashboard:
- https://www.virustotal.com/gui/user/YOUR_USERNAME/apikey
- **Daily quota:** 500 / 500
- **Minute quota:** 4 / 4

### –ï—Å–ª–∏ –∫–≤–æ—Ç–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è:

**Option 1:** Upgrade to Premium ($192/month)
- 15,000 requests/day
- 500 requests/minute

**Option 2:** –î–æ–±–∞–≤–∏—Ç—å ClamAV (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- –°–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é: `docs/GMAIL_ATTACHMENT_SCANNING.md`
- Docker container –Ω–∞ Render (+$7/month –∑–∞ RAM)

---

## üêõ Troubleshooting:

### –ü—Ä–æ–±–ª–µ–º–∞: "API key not configured"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –í Render Shell
echo $VIRUSTOTAL_API_KEY
# –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Üí –¥–æ–±–∞–≤—å—Ç–µ –≤ Environment variables
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: "Upload failed: 403"

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–≤–æ—Ç–∞ –∏—Å—á–µ—Ä–ø–∞–Ω–∞ (500/–¥–µ–Ω—å)

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ–¥–æ–∂–¥–∏—Ç–µ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è (UTC)
- –ò–ª–∏ upgrade to Premium

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
flask db current
# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: e8a4b92c5d11
```

**–ï—Å–ª–∏ –Ω–µ—Ç:**
```bash
flask db upgrade
```

---

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

### 1. UI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è scan results

–°–æ–∑–¥–∞—Ç—å template –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–ª–æ–∂–µ–Ω–∏–π:
- ‚úÖ Badge —Å —É—Ä–æ–≤–Ω–µ–º —Ä–∏—Å–∫–∞
- üîó –°—Å—ã–ª–∫–∞ –Ω–∞ VirusTotal report
- üìã –°–ø–∏—Å–æ–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —É–≥—Ä–æ–∑

### 2. Quarantine management

Admin dashboard –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä–∞–Ω—Ç–∏–Ω–æ–º:
- –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∏—Å–µ–º
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å (whitelist)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π

### 3. Webhook –¥–ª—è async results

VirusTotal –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å webhook –∫–æ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω:
- –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å 30-60 —Å–µ–∫—É–Ω–¥
- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üí° Best Practices:

1. **–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ API –∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**
   - –•—Ä–∞–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –≤ environment variables
   - –ù–µ –ª–æ–≥–∏—Ä—É–π—Ç–µ –ø–æ–ª–Ω—ã–π –∫–ª—é—á

2. **–ö—ç—à–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ SHA256**
   - –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª—Å—è ‚Üí –Ω–µ —Ç—Ä–∞—Ç—å—Ç–µ API quota
   - –•—Ä–∞–Ω–∏—Ç–µ –≤ `attachments_json`

3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∫–≤–æ—Ç—É**
   - –õ–æ–≥–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—ã–π API call
   - –ê–ª–µ—Ä—Ç—å—Ç–µ –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –ª–∏–º–∏—Ç—É

4. **Fallback –Ω–∞ quick scan**
   - –ï—Å–ª–∏ VirusTotal –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
   - –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ Checklist –ø–µ—Ä–µ–¥ production:

- [ ] VirusTotal API –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ Render
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ
- [ ] –¢–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ö–≤–æ—Ç–∞ VirusTotal –Ω–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∞
- [ ] Gmail OAuth —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –≤–ª–æ–∂–µ–Ω–∏–π (TODO)

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `VIRUSTOTAL_API_KEY` –≤ Render –≤—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- –ü–æ–ª–Ω–∞—è: `docs/GMAIL_ATTACHMENT_SCANNING.md`
- –ö–æ–¥: `app/mailguard/attachment_scanner.py`
- –ú–∏–≥—Ä–∞—Ü–∏—è: `migrations/versions/e8a4b92c5d11_*.py`

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 7 –Ω–æ—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ production (–ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è API key)
