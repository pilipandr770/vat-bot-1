{% extends "base.html" %}

{% block title %}Перевірка контрагента{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Column: Company Data -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-building"></i> Дані вашої компанії</h5>
            </div>
            <div class="card-body">
                <form id="verificationForm">
                    <div class="mb-3">
                        <label for="company_vat" class="form-label">VAT номер <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="company_vat" name="company_vat" 
                               placeholder="DE123456789" required>
                        <div class="form-text">Ваш VAT номер для VIES перевірки</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="company_name" class="form-label">Назва компанії <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="company_name" name="company_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="company_address" class="form-label">Юридична адреса <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="company_address" name="company_address" 
                                  rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="company_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="company_email" name="company_email">
                    </div>
                    
                    <div class="mb-3">
                        <label for="company_phone" class="form-label">Телефон</label>
                        <input type="tel" class="form-control" id="company_phone" name="company_phone">
                    </div>
            </div>
        </div>
    </div>

    <!-- Middle Column: Counterparty Data -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="bi bi-person-badge"></i> Дані контрагента</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="counterparty_vat" class="form-label">VAT номер</label>
                    <input type="text" class="form-control" id="counterparty_vat" name="counterparty_vat" 
                           placeholder="DE987654321">
                    <div class="form-text">VAT номер контрагента (якщо відомий)</div>
                </div>
                
                <div class="mb-3">
                    <label for="counterparty_name" class="form-label">Назва компанії <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="counterparty_name" name="counterparty_name" required>
                </div>
                
                <div class="mb-3">
                    <label for="counterparty_country" class="form-label">Країна <span class="text-danger">*</span></label>
                    <select class="form-select" id="counterparty_country" name="counterparty_country" required>
                        <option value="">Оберіть країну</option>
                        <option value="DE">Німеччина</option>
                        <option value="AT">Австрія</option>
                        <option value="NL">Нідерланди</option>
                        <option value="FR">Франція</option>
                        <option value="IT">Італія</option>
                        <option value="ES">Іспанія</option>
                        <option value="PL">Польща</option>
                        <option value="CZ">Чехія</option>
                        <option value="UA">Україна</option>
                        <option value="US">США</option>
                        <option value="GB">Велика Британія</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="counterparty_address" class="form-label">Адреса з Impressum</label>
                    <textarea class="form-control" id="counterparty_address" name="counterparty_address" rows="3"></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="counterparty_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="counterparty_email" name="counterparty_email">
                </div>
                
                <div class="mb-3">
                    <label for="counterparty_domain" class="form-label">Домен сайту</label>
                    <input type="text" class="form-control" id="counterparty_domain" name="counterparty_domain" 
                           placeholder="example.com">
                </div>
                
                <div class="mb-3">
                    <label for="counterparty_contact" class="form-label">Контактна особа</label>
                    <input type="text" class="form-control" id="counterparty_contact" name="counterparty_contact">
                </div>
                
                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-search"></i> Запустити перевірку
                </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Column: Verification Results -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-clipboard-check"></i> Результати перевірки</h5>
            </div>
            <div class="card-body" id="resultsPanel">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-arrow-left-circle fs-1"></i>
                    <p class="mt-2">Заповніть форми та натисніть "Запустити перевірку"</p>
                </div>
            </div>
        </div>
        
        <!-- Loading indicator -->
        <div class="card mt-3" id="loadingPanel" style="display: none;">
            <div class="card-body text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Виконується перевірка...</p>
                <div id="loadingProgress"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('verificationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const loadingPanel = document.getElementById('loadingPanel');
    const resultsPanel = document.getElementById('resultsPanel');
    
    // Show loading
    loadingPanel.style.display = 'block';
    resultsPanel.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-hourglass-split fs-1"></i><p class="mt-2">Обробка...</p></div>';
    
    // Submit form
    fetch('/verify', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        loadingPanel.style.display = 'none';
        
        if (data.success) {
            displayResults(data);
        } else {
            displayError(data.error || 'Невідома помилка');
        }
    })
    .catch(error => {
        loadingPanel.style.display = 'none';
        displayError('Помилка з\'єднання: ' + error.message);
    });
});

function displayResults(data) {
    const resultsPanel = document.getElementById('resultsPanel');
    let html = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <strong>Загальний статус:</strong>
                <span class="badge ${getStatusBadgeClass(data.overall_status)}">${getStatusText(data.overall_status)}</span>
            </div>
            <div class="progress mt-2">
                <div class="progress-bar" style="width: ${data.confidence_score * 100}%">${Math.round(data.confidence_score * 100)}%</div>
            </div>
        </div>
        
        <div class="accordion" id="resultsAccordion">
    `;
    
    let index = 0;
    for (const [service, result] of Object.entries(data.results)) {
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                        <i class="bi ${getServiceIcon(service)} me-2"></i>
                        ${getServiceName(service)}
                        <span class="badge ${getStatusBadgeClass(result.status)} ms-auto me-2">${getStatusText(result.status)}</span>
                    </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     data-bs-parent="#resultsAccordion">
                    <div class="accordion-body">
                        ${formatServiceResult(service, result)}
                    </div>
                </div>
            </div>
        `;
        index++;
    }
    
    html += '</div>';
    resultsPanel.innerHTML = html;
}

function displayError(message) {
    const resultsPanel = document.getElementById('resultsPanel');
    resultsPanel.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> ${message}
        </div>
    `;
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'valid': return 'bg-success';
        case 'warning': return 'bg-warning text-dark';
        case 'error': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'valid': return '✅ Валідно';
        case 'warning': return '⚠️ Попередження';
        case 'error': return '❌ Проблема';
        default: return '⏳ Очікування';
    }
}

function getServiceIcon(service) {
    switch(service) {
        case 'vies': return 'bi-patch-check';
        case 'handelsregister': return 'bi-building';
        case 'sanctions': return 'bi-shield-exclamation';
        default: return 'bi-gear';
    }
}

function getServiceName(service) {
    switch(service) {
        case 'vies': return 'VIES VAT перевірка';
        case 'handelsregister': return 'Handelsregister';
        case 'sanctions': return 'Санкційні списки';
        default: return service.toUpperCase();
    }
}

function formatServiceResult(service, result) {
    let html = `<p><strong>Статус:</strong> ${getStatusText(result.status)}</p>`;
    
    if (result.data) {
        html += '<p><strong>Дані:</strong></p><pre>' + JSON.stringify(result.data, null, 2) + '</pre>';
    }
    
    if (result.error_message) {
        html += `<p><strong>Помилка:</strong> ${result.error_message}</p>`;
    }
    
    return html;
}
</script>
{% endblock %}