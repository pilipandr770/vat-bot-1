{% extends "base.html" %}

{% block title %}Website Security Scanner - Pentesting{% endblock %}

{% block content %}
<div class="pentesting-container">
    <div class="pentesting-header">
        <h1>
            <i class="bi bi-shield-exclamation"></i>
            Website Security Scanner
        </h1>
        <p class="subtitle">Comprehensive website vulnerability assessment with AI-powered insights</p>
    </div>

    <div id="subscriptionBanner" class="subscription-banner" style="display: none;">
        <strong>‚ö†Ô∏è This feature is only available for PRO and ENTERPRISE users</strong>
        <p style="margin-bottom: 10px;">Upgrade now to protect your website</p>
        <a href="{{ url_for('payments.pricing') }}" class="btn btn-warning">Upgrade Now</a>
    </div>

    <div class="scanner-card">
        <form id="scanForm">
            <div class="form-group">
                <label for="urlInput">Enter Website URL:</label>
                <div class="input-group">
                    <input
                        type="text"
                        id="urlInput"
                        placeholder="e.g. example.com or https://example.com"
                        required
                    >
                    <button type="submit" class="btn btn-primary" id="scanBtn">
                        <i class="bi bi-search"></i> Start Scan
                    </button>
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input
                        type="checkbox"
                        id="aiAnalysis"
                        checked
                    >
                    <label for="aiAnalysis" style="margin: 0; cursor: pointer;">
                        <i class="bi bi-robot"></i> AI-Powered Analysis with Recommendations
                    </label>
                </div>
            </div>
        </form>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Analyzing website security...</p>
    </div>

    <div id="errorMessage" class="error-message"></div>

    <div id="results" class="results">
        <div id="scoreCard" class="score-card">
            <div class="score-label">Security Score</div>
            <div class="score-number" id="scoreNumber">-</div>
            <div class="risk-level" id="riskLevel">-</div>
        </div>

        <div id="aiAnalysisContainer" class="ai-analysis" style="display: none;">
            <h3>
                <i class="bi bi-robot"></i>
                AI-Powered Analysis
            </h3>
            <div class="ai-content" id="aiAnalysisContent"></div>
        </div>

        <div id="checksContainer" class="checks-grid"></div>

        <div class="results-actions">
            <button class="btn btn-secondary" onclick="resetScanner();">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <button class="btn btn-secondary" onclick="exportReport();">
                <i class="bi bi-download"></i> Export Report
            </button>
        </div>
    </div>
</div>

<style>
    .pentesting-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px 15px;
    }

    .pentesting-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .pentesting-header h1 {
        font-size: 2.5em;
        color: #333;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .pentesting-header i {
        color: #667eea;
        font-size: 2.8em;
    }

    .pentesting-header .subtitle {
        font-size: 1.1em;
        color: #666;
        margin: 0;
    }

    .scanner-card {
        background: white;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        border: 1px solid #e0e0e0;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 12px;
        color: #333;
        font-size: 1.05em;
    }

    .input-group {
        display: flex;
        gap: 12px;
    }

    .form-group input[type="url"],
    .form-group input[type="text"] {
        flex: 1;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        transition: all 0.3s;
        font-family: inherit;
    }

    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        padding: 14px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: white;
        color: #333;
        border: 2px solid #e0e0e0;
    }

    .btn-secondary:hover {
        background: #f5f5f5;
        border-color: #ccc;
    }

    .btn-warning {
        background: #ffc107;
        color: #333;
    }

    .btn-warning:hover {
        background: #ffb300;
        transform: translateY(-2px);
    }

    .checkbox-group {
        display: flex;
        gap: 20px;
        margin-bottom: 0;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #667eea;
    }

    .checkbox-item label {
        margin: 0 !important;
        cursor: pointer;
        font-weight: normal;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .results {
        display: none;
    }

    .results.active {
        display: block;
    }

    .score-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 50px 40px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .score-label {
        font-size: 1.2em;
        margin-bottom: 15px;
        opacity: 0.9;
    }

    .score-number {
        font-size: 5em;
        font-weight: bold;
        margin-bottom: 15px;
        line-height: 1;
    }

    .risk-level {
        font-size: 1.4em;
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: inline-block;
        font-weight: 600;
    }

    .risk-critical {
        background: #ff4757 !important;
    }

    .risk-high {
        background: #ffa502 !important;
    }

    .risk-medium {
        background: #ffc107 !important;
        color: #333 !important;
    }

    .risk-low {
        background: #2ed573 !important;
    }

    .checks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .check-card {
        background: white;
        border-left: 5px solid #ccc;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
    }

    .check-card.passed {
        border-left-color: #2ed573;
    }

    .check-card.passed .check-title {
        color: #2ed573;
    }

    .check-card.warning {
        border-left-color: #ffc107;
    }

    .check-card.warning .check-title {
        color: #ffc107;
    }

    .check-card.failed {
        border-left-color: #ff4757;
    }

    .check-card.failed .check-title {
        color: #ff4757;
    }

    .check-title {
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 14px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        white-space: nowrap;
    }

    .status-passed {
        background: #d4edda;
        color: #155724;
    }

    .status-warning {
        background: #fff3cd;
        color: #856404;
    }

    .status-failed {
        background: #f8d7da;
        color: #721c24;
    }

    .check-issues {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    .check-issues li {
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.95em;
        color: #555;
    }

    .check-issues li:last-child {
        border-bottom: none;
    }

    .ai-analysis {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .ai-analysis h3 {
        color: #667eea;
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2em;
    }

    .ai-content {
        color: #333;
        line-height: 1.8;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 60px 20px;
    }

    .loading.active {
        display: block;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #ff4757;
        display: none;
    }

    .error-message.active {
        display: block;
    }

    .subscription-banner {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 30px;
        text-align: center;
        color: #856404;
    }

    .subscription-banner strong {
        display: block;
        margin-bottom: 12px;
        font-size: 1.05em;
    }

    .results-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 40px;
    }

    @media (max-width: 768px) {
        .pentesting-container {
            padding: 15px;
        }

        .pentesting-header h1 {
            font-size: 1.8em;
        }

        .scanner-card {
            padding: 20px;
        }

        .input-group {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .score-number {
            font-size: 3.5em;
        }

        .checks-grid {
            grid-template-columns: 1fr;
        }

        .results-actions {
            flex-direction: column;
        }

        .results-actions .btn {
            width: 100%;
        }
    }
</style>

<script>
    const API_BASE = '/api/pentesting';
    let lastResults = null;

    // Check subscription on load
    document.addEventListener('DOMContentLoaded', async () => {
        await checkSubscriptionStatus();
    });

    async function checkSubscriptionStatus() {
        try {
            const response = await fetch(`${API_BASE}/status`);
            const data = await response.json();

            if (!data.available) {
                document.getElementById('subscriptionBanner').style.display = 'block';
                document.getElementById('scanForm').style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking subscription:', error);
        }
    }

    document.getElementById('scanForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await performScan();
    });

    async function performScan() {
        const url = document.getElementById('urlInput').value.trim();
        const includeAI = document.getElementById('aiAnalysis').checked;

        if (!url) {
            showError('Please enter a URL');
            return;
        }

        showLoading(true);
        clearError();

        try {
            const response = await fetch(`${API_BASE}/scan`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: url,
                    include_ai_analysis: includeAI,
                    language: 'en'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Scan failed');
            }

            const data = await response.json();
            lastResults = data;
            displayResults(data);

        } catch (error) {
            console.error('Scan error:', error);
            showError(error.message || 'An error occurred during the scan');
        } finally {
            showLoading(false);
        }
    }

    function displayResults(data) {
        const results = data.scan_results;
        const analysis = data.ai_analysis;

        // Display score
        const score = results.overall_score;
        const risk = getRiskLevel(score);

        document.getElementById('scoreNumber').textContent = Math.round(score);
        const riskLevel = document.getElementById('riskLevel');
        riskLevel.textContent = getRiskLevelText(risk);
        riskLevel.className = 'risk-level risk-' + risk.toLowerCase();

        // Display AI analysis if available
        if (analysis && analysis.analysis) {
            document.getElementById('aiAnalysisContainer').style.display = 'block';
            document.getElementById('aiAnalysisContent').textContent = analysis.analysis;
        } else {
            document.getElementById('aiAnalysisContainer').style.display = 'none';
        }

        // Display check results
        const checksContainer = document.getElementById('checksContainer');
        checksContainer.innerHTML = '';

        for (const [checkName, checkResult] of Object.entries(results.checks)) {
            const checkCard = createCheckCard(checkName, checkResult);
            checksContainer.appendChild(checkCard);
        }

        document.getElementById('results').classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function createCheckCard(name, result) {
        const card = document.createElement('div');
        card.className = `check-card ${result.status.toLowerCase()}`;

        let statusHtml = `<span class="status-badge status-${result.status.toLowerCase()}">${result.status}</span>`;

        let issuesHtml = '';
        if (result.issues && result.issues.length > 0) {
            issuesHtml = `<ul class="check-issues">${result.issues.map(issue => `<li>‚Ä¢ ${issue}</li>`).join('')}</ul>`;
        }

        const title = getCheckTitle(name);
        card.innerHTML = `
            <div class="check-title">
                <span>${title}</span>
                ${statusHtml}
            </div>
            ${issuesHtml}
        `;

        return card;
    }

    function getCheckTitle(name) {
        const titles = {
            'ssl_tls': 'üîê SSL/TLS Check',
            'security_headers': 'üõ°Ô∏è Security Headers',
            'sql_injection': 'üíâ SQL Injection Test',
            'xss': '‚ö†Ô∏è XSS Vulnerability',
            'csrf': 'üõ°Ô∏è CSRF Protection',
            'open_ports': 'üì° Open Ports',
            'dnssec': 'üîë DNSSEC'
        };
        return titles[name] || name;
    }

    function getRiskLevel(score) {
        if (score >= 80) return 'LOW';
        if (score >= 60) return 'MEDIUM';
        if (score >= 40) return 'HIGH';
        return 'CRITICAL';
    }

    function getRiskLevelText(risk) {
        const texts = {
            'LOW': '‚úÖ Low Risk',
            'MEDIUM': '‚ö†Ô∏è Medium Risk',
            'HIGH': 'üî¥ High Risk',
            'CRITICAL': 'üö® Critical Risk'
        };
        return texts[risk] || risk;
    }

    function showLoading(show) {
        document.getElementById('loading').classList.toggle('active', show);
    }

    function showError(message) {
        const errorEl = document.getElementById('errorMessage');
        errorEl.textContent = message;
        errorEl.classList.add('active');
    }

    function clearError() {
        document.getElementById('errorMessage').classList.remove('active');
    }

    function resetScanner() {
        document.getElementById('scanForm').reset();
        document.getElementById('results').classList.remove('active');
        clearError();
    }

    function exportReport() {
        if (!lastResults) return;

        const report = generateReport(lastResults);
        const blob = new Blob([report], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `security-report-${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function generateReport(data) {
        let report = 'WEBSITE SECURITY REPORT\n';
        report += '='.repeat(50) + '\n\n';
        report += `Domain: ${data.scan_results.domain}\n`;
        report += `Date: ${data.timestamp}\n`;
        report += `Security Score: ${data.scan_results.overall_score}/100\n\n`;

        report += 'RESULTS:\n';
        report += '-'.repeat(50) + '\n';

        for (const [check, result] of Object.entries(data.scan_results.checks)) {
            report += `\n${getCheckTitle(check)}\n`;
            report += `Status: ${result.status}\n`;
            if (result.issues && result.issues.length > 0) {
                report += 'Issues:\n';
                result.issues.forEach(issue => {
                    report += `  - ${issue}\n`;
                });
            }
        }

        if (data.ai_analysis && data.ai_analysis.analysis) {
            report += '\n\nAI ANALYSIS:\n';
            report += '-'.repeat(50) + '\n';
            report += data.ai_analysis.analysis + '\n';
        }

        return report;
    }
</script>
{% endblock %}
