{% extends 'base.html' %}

{% block title %}Phone Intelligence{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header">
          <h2 class="mb-0"><i class="bi bi-telephone"></i> Phone Intelligence</h2>
        </div>
        <div class="card-body">
          <p class="text-muted">Analyze phone numbers for carrier information, line type, and risk assessment. No personal data is stored.</p>
          
          <form id="phone-form" class="mb-4">
            <div class="row">
              <div class="col-md-8">
                <label for="phone" class="form-label">Phone Number</label>
                <input id="phone" name="phone" class="form-control" placeholder="+491512345678" required />
              </div>
              <div class="col-md-4">
                <label for="country" class="form-label">Country Hint (ISO2)</label>
                <input id="country" name="country" class="form-control" placeholder="DE" />
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3" id="analyze-btn">
              <i class="bi bi-search"></i> Analyze
            </button>
          </form>

          <div id="result" class="mt-4" style="display: none;">
            <h5>Analysis Results</h5>
            <div id="result-content"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('phone-form').addEventListener('submit', async function(e){
  e.preventDefault();
  const btn = document.getElementById('analyze-btn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyzing...';
  btn.disabled = true;

  const phone = document.getElementById('phone').value;
  const country = document.getElementById('country').value;
  const resultDiv = document.getElementById('result');
  const resultContent = document.getElementById('result-content');

  try {
    const resp = await fetch('/phoneintel/api/analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({phone_number: phone, country: country})
    });
    const json = await resp.json();

    if (json.success) {
      const data = json.data;
      let html = '<div class="row">';
      
      // Basic info
      html += '<div class="col-md-6"><h6>Basic Information</h6><ul class="list-group">';
      html += `<li class="list-group-item"><strong>Country:</strong> ${data.country || 'Unknown'}</li>`;
      html += `<li class="list-group-item"><strong>Carrier:</strong> ${data.carrier || 'Unknown'}</li>`;
      html += `<li class="list-group-item"><strong>Line Type:</strong> ${data.line_type}</li>`;
      html += '</ul></div>';
      
      // Risk assessment
      html += '<div class="col-md-6"><h6>Risk Assessment</h6><ul class="list-group">';
      html += `<li class="list-group-item"><strong>Risk Score:</strong> ${data.risk_score}/100</li>`;
      html += `<li class="list-group-item"><strong>Verdict:</strong> <span class="badge bg-${data.verdict === 'high' ? 'danger' : data.verdict === 'medium' ? 'warning' : 'success'}">${data.verdict}</span></li>`;
      html += `<li class="list-group-item"><strong>Disposable:</strong> ${data.disposable ? 'Yes' : 'No'}</li>`;
      html += `<li class="list-group-item"><strong>Seen in Scam DB:</strong> ${data.seen_in_scam_db ? 'Yes' : 'No'}</li>`;
      html += '</ul></div>';
      
      html += '</div>';
      
      if (data.suspicious_patterns && data.suspicious_patterns.length > 0) {
        html += '<div class="mt-3"><h6>Suspicious Patterns</h6><ul class="list-group">';
        data.suspicious_patterns.forEach(pattern => {
          html += `<li class="list-group-item list-group-item-warning">${pattern}</li>`;
        });
        html += '</ul></div>';
      }
      
      resultContent.innerHTML = html;
      resultDiv.style.display = 'block';
    } else {
      resultContent.innerHTML = `<div class="alert alert-danger">${json.error || 'Analysis failed'}</div>`;
      resultDiv.style.display = 'block';
    }
  } catch (error) {
    resultContent.innerHTML = '<div class="alert alert-danger">Network error occurred</div>';
    resultDiv.style.display = 'block';
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
});
</script>

{% endblock %}
