# ‚úÖ OAuth Integration - –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!

## üéâ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### ‚úÖ Gmail OAuth:
- Route: `/mailguard/auth/gmail` - –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç OAuth
- Route: `/mailguard/auth/gmail/callback` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç Google
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ email —á–µ—Ä–µ–∑ Gmail API
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å –ø–æ–º–æ—â—å—é Fernet
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### ‚úÖ Microsoft OAuth:
- Route: `/mailguard/auth/microsoft` - –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç OAuth
- Route: `/mailguard/auth/microsoft/callback` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç Microsoft
- –ü–æ–ª—É—á–µ–Ω–∏–µ email —á–µ—Ä–µ–∑ Microsoft Graph API
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

### ‚úÖ IMAP Setup:
- Route: `/mailguard/accounts/add-imap` - —Ñ–æ—Ä–º–∞ –¥–ª—è IMAP
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º

### ‚úÖ Account Management:
- `/accounts/<id>/sync` - —Ä—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- `/accounts/<id>/toggle` - –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å
- `/accounts/<id>/delete` - —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

### 1. –î–æ–∂–¥–∏—Ç–µ—Å—å –¥–µ–ø–ª–æ—è –Ω–∞ Render (~2 –º–∏–Ω—É—Ç—ã)
Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–µ—Ä–Ω–µ—Ç –Ω–æ–≤—ã–π –∫–æ–¥ –ø–æ—Å–ª–µ git push

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ env variables
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Render Dashboard –¥–æ–±–∞–≤–ª–µ–Ω—ã:
- ‚úÖ GMAIL_CLIENT_ID
- ‚úÖ GMAIL_CLIENT_SECRET
- ‚úÖ MAILGUARD_ENCRYPTION_KEY

### 3. –¢–µ—Å—Ç Gmail OAuth:

**–®–∞–≥ 1**: –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
```
https://vat-bot-1.onrender.com/mailguard/accounts
```

**–®–∞–≥ 2**: –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üî¥ –ü–æ–¥–∫–ª—é—á–∏—Ç—å Gmail"

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**:
- –û—Ç–∫—Ä–æ–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Google
- –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: "Read, compose, send, and permanently delete all your email from Gmail"
- –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "Allow" ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ /mailguard/accounts
- –ê–∫–∫–∞—É–Ω—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ —Å –∑–µ–ª–µ–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω"

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å**:
- ‚úÖ Email –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü—Ä–æ–≤–∞–π–¥–µ—Ä: Gmail (—Å –∫—Ä–∞—Å–Ω–æ–π –∏–∫–æ–Ω–∫–æ–π Google)
- ‚úÖ –°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–µ–Ω
- ‚úÖ Flash message: "Gmail –∞–∫–∫–∞—É–Ω—Ç xxx@gmail.com —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!"

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:

–í Render Shell:
```bash
flask shell
>>> from app.mailguard.models import MailAccount
>>> accounts = MailAccount.query.all()
>>> for acc in accounts:
...     print(f"{acc.email} - {acc.provider} - Active: {acc.is_active}")
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è**:
- –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ `MailAccount`
- `access_token` –∏ `refresh_token` –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å "gAAAAA...")
- `expires_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (~1 —á–∞—Å –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)

---

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏:

### –û—à–∏–±–∫–∞: "redirect_uri_mismatch"
**–ü—Ä–∏—á–∏–Ω–∞**: –í Google Cloud Console –Ω–µ–≤–µ—Ä–Ω—ã–π redirect URI

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Google Cloud Console:
```
Authorized redirect URIs:
https://vat-bot-1.onrender.com/mailguard/auth/gmail/callback
```
‚ö†Ô∏è –ë–µ–∑ trailing slash!

### –û—à–∏–±–∫–∞: "invalid_client"
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–≤–µ—Ä–Ω—ã–π Client ID –∏–ª–∏ Secret –≤ env vars

**–†–µ—à–µ–Ω–∏–µ**: 
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ Render Dashboard
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è env vars

### –û—à–∏–±–∫–∞: "encryption key not found"
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ –¥–æ–±–∞–≤–ª–µ–Ω MAILGUARD_ENCRYPTION_KEY

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –≤ Render env vars

### –û—à–∏–±–∫–∞: 500 Internal Server Error
**–ü—Ä–∏—á–∏–Ω–∞**: –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Render:
```
Render Dashboard ‚Üí Your Service ‚Üí Logs
```

---

## üìù –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:

1. ‚úÖ Gmail OAuth —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚è≥ Microsoft OAuth (–¥–æ–±–∞–≤–∏—Ç–µ –∫–ª—é—á–∏ –ø–æ–∑–∂–µ)
3. ‚è≥ Background email polling (Phase 2)
4. ‚è≥ Email sending (Phase 3)

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Gmail:
- **Phase 2**: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å APScheduler –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—á—Ç—ã
- **Phase 3**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –ø–∏—Å–µ–º
- **Phase 4**: –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç workflow (–ø–æ–ª—É—á–µ–Ω–∏–µ ‚Üí AI –æ—Ç–≤–µ—Ç ‚Üí –æ–¥–æ–±—Ä–µ–Ω–∏–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞)

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–≤–æ—é Gmail –ø–æ—á—Ç—É! üéâ**
