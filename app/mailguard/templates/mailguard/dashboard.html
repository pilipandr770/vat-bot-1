<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MailGuard - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('mailguard.dashboard') }}">
                <i class="bi bi-envelope-check"></i> MailGuard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="btn btn-outline-light btn-sm" href="{{ url_for('dashboard') }}">
                    <i class="bi bi-house"></i> Hauptmenü
                </a>
                <a class="btn btn-outline-light btn-sm ms-2" href="{{ url_for('mailguard.accounts') }}">
                    <i class="bi bi-envelope-at"></i> Konten
                </a>
                <a class="btn btn-outline-light btn-sm ms-2" href="{{ url_for('mailguard.messages') }}">
                    <i class="bi bi-inbox"></i> Posteingang
                </a>
                <a class="btn btn-outline-light btn-sm ms-2" href="{{ url_for('mailguard.rules') }}">
                    <i class="bi bi-funnel"></i> Regeln
                </a>
                <a class="btn btn-outline-light btn-sm ms-2" href="{{ url_for('mailguard.counterparties') }}">
                    <i class="bi bi-people"></i> Kontakte
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h1>MailGuard Dashboard</h1>
                <p class="text-muted">Intelligente E-Mail-Verarbeitung und Sicherheitsprüfung</p>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                {% set counts = security_overview.counts %}
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Sicherheitsüberblick</h5>
                        <span class="text-muted small">Letzte 20 Nachrichten</span>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-sm-3 col-6 mb-3 mb-sm-0">
                                <div class="display-6 text-success">{{ counts.safe or 0 }}</div>
                                <div class="text-muted">Sicher</div>
                            </div>
                            <div class="col-sm-3 col-6 mb-3 mb-sm-0">
                                <div class="display-6 text-warning">{{ counts.warning or 0 }}</div>
                                <div class="text-muted">Warnungen</div>
                            </div>
                            <div class="col-sm-3 col-6">
                                <div class="display-6 text-danger">{{ counts.blocked or 0 }}</div>
                                <div class="text-muted">Blockiert</div>
                            </div>
                            <div class="col-sm-3 col-6">
                                <div class="display-6 text-secondary">{{ counts.review or 0 }}</div>
                                <div class="text-muted">Manuell prüfen</div>
                            </div>
                        </div>

                        {% if security_overview.flagged %}
                            <div class="mt-4">
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#securityFlagged">
                                    Detailbericht anzeigen
                                </button>
                                <div class="collapse mt-3" id="securityFlagged">
                                    <div class="list-group">
                                        {% for item in security_overview.flagged %}
                                            <a href="{{ url_for('mailguard.message_detail', message_id=item.id) }}" class="list-group-item list-group-item-action">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <span class="badge bg-{{ item.flag_color }} me-2">{{ item.status_label }}</span>
                                                        <strong>{{ item.subject }}</strong>
                                                        <div class="text-muted small">Von: {{ item.from_email }}</div>
                                                    </div>
                                                    <div class="text-muted small text-end">
                                                        {% if item.score is not none %}
                                                            Score: {{ item.score }}/100<br>
                                                        {% endif %}
                                                        {{ item.received_at.strftime('%d.%m.%Y %H:%M') if item.received_at else '' }}
                                                    </div>
                                                </div>
                                                {% if item.summary %}
                                                    <div class="small text-muted mt-2">{{ item.summary }}</div>
                                                {% endif %}
                                                {% if item.checked_at_display %}
                                                    <div class="small text-muted mt-1">Geprüft: {{ item.checked_at_display }}</div>
                                                {% endif %}
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Подключенные аккаунты -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Verbundene E-Mail-Konten</h5>
                    </div>
                    <div class="card-body">
                        {% if accounts %}
                            <div class="row">
                                {% for account in accounts %}
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">{{ account.provider.title() }}</h6>
                                            <p class="card-text">{{ account.email }}</p>
                                            <span class="badge bg-{{ 'success' if account.is_active else 'secondary' }}">
                                                {{ 'Aktiv' if account.is_active else 'Inaktiv' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                                <p class="text-muted mt-3 mb-4">Keine E-Mail-Konten verbunden</p>
                                <a href="{{ url_for('mailguard.accounts') }}" class="btn btn-primary btn-lg">
                                    <i class="bi bi-plus-circle"></i> E-Mail-Konto hinzufügen
                                </a>
                                <p class="text-muted small mt-3">
                                    Gmail, Outlook, Office 365 oder IMAP
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Ожидающие черновики -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Ausstehende Antworten ({{ pending_drafts|length }})</h5>
                    </div>
                    <div class="card-body">
                        {% if pending_drafts %}
                            <div class="list-group">
                                {% for draft in pending_drafts %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ draft.subject }}</h6>
                                        <small>{{ draft.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                    </div>
                                    <p class="mb-1">Von: {{ draft.message.from_email }}</p>
                                    {% set preview_source = draft.body_text or (draft.body_html | striptags if draft.body_html else '') %}
                                    {% if preview_source %}
                                        <p class="text-muted small mb-2">
                                            {{ preview_source[:160] }}{% if preview_source|length > 160 %}…{% endif %}
                                        </p>
                                    {% endif %}
                                    <small class="text-muted">
                                        Vorgeschlagen von: {{ draft.suggested_by }}
                                        {% if draft.message.risk_score %}
                                            | Risiko: {{ draft.message.risk_score }}/100
                                        {% endif %}
                                    </small>
                                    <div class="mt-2">
                                        <a href="{{ url_for('mailguard.message_detail', message_id=draft.message_id) }}" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-eye"></i> Nachricht
                                        </a>
                                        <form method="POST" action="{{ url_for('mailguard.approve_and_send', draft_id=draft.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-success btn-sm">Senden</button>
                                        </form>
                                        <form method="POST" action="{{ url_for('mailguard.reject_draft', draft_id=draft.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-danger btn-sm">Ablehnen</button>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">Keine ausstehenden Antworten.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Последние сообщения -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Letzte Nachrichten</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_messages %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">Sicherheit</th>
                                            <th>Von</th>
                                            <th>Betreff</th>
                                            <th>Erhalten</th>
                                            <th>Status</th>
                                            <th>Risiko</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for message in recent_messages %}
                                        {% set security = message.get_security_meta() %}
                                        <tr>
                                            <td>
                                                {% set flag_icon = (security.flag_icon if security else None) or 'bi-shield' %}
                                                {% set flag_color = (security.flag_color if security else 'secondary') %}
                                                <span class="badge bg-{{ flag_color }}">
                                                    <i class="bi {{ flag_icon }}"></i>
                                                </span>
                                            </td>
                                            <td>{{ message.from_email }}</td>
                                            <td>
                                                <a href="{{ url_for('mailguard.message_detail', message_id=message.id) }}" class="text-decoration-none">
                                                    {{ message.subject[:50] if message.subject else '(без темы)' }}{% if message.subject and message.subject|length > 50 %}...{% endif %}
                                                </a>
                                            </td>
                                            <td>{{ message.received_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                            <td>
                                                {% set status_map = {
                                                    'new': ('primary', 'Neu'),
                                                    'scanned': ('info', 'Gescannt'),
                                                    'drafted': ('warning', 'Entwurf'),
                                                    'sent': ('success', 'Gesendet'),
                                                    'quarantined': ('danger', 'Quarantäne'),
                                                    'skipped': ('secondary', 'Übersprungen')
                                                } %}
                                                {% set status_badge = status_map.get(message.status or 'new', ('secondary', message.status or 'Unbekannt')) %}
                                                <span class="badge bg-{{ status_badge[0] }}">{{ status_badge[1] }}</span>
                                            </td>
                                            <td>
                                                {% if message.risk_score %}
                                                    <span class="badge bg-{{ 'danger' if message.risk_score > 70 else 'warning' if message.risk_score > 40 else 'success' }}">
                                                        {{ message.risk_score }}/100
                                                    </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">Keine Nachrichten gefunden.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>