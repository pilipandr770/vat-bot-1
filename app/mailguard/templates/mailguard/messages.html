{% extends "base.html" %}

{% block title %}Mailbox - MailGuard{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Hauptmenü</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('mailguard.dashboard') }}">MailGuard</a></li>
            <li class="breadcrumb-item active">Posteingang</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-inbox"></i> Posteingang</h2>
        <a href="{{ url_for('mailguard.dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Zurück zum Dashboard
        </a>
    </div>

    {% if messages %}
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>Absender</th>
                        <th>Betreff</th>
                        <th>Status</th>
                        <th>Risiko</th>
                        <th style="width: 160px;">Eingang</th>
                        <th style="width: 60px;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for message in messages %}
                    <tr>
                        <td>
                            {% if message.has_dangerous_attachments %}
                                <span class="badge bg-danger" title="Gefährliche Anhänge"><i class="bi bi-exclamation-triangle"></i></span>
                            {% elif message.has_attachments %}
                                <span class="badge bg-info text-dark" title="Anhänge vorhanden"><i class="bi bi-paperclip"></i></span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ message.from_email }}</strong><br>
                            <small class="text-muted">{{ message.account.email }}</small>
                        </td>
                        <td>
                                <a href="{{ url_for('mailguard.message_detail', message_id=message.id) }}" class="text-decoration-none">
                                    {{ message.subject or "(без темы)" }}
                                </a>
                        </td>
                        <td>
                            {% set status_badges = {
                                'new': ('secondary', 'Neu'),
                                'scanned': ('info', 'Gescannt'),
                                'drafted': ('primary', 'Entwurf'),
                                'sent': ('success', 'Versendet'),
                                'quarantined': ('danger', 'Quarantäne'),
                                'skipped': ('secondary', 'Ignoriert')
                            } %}
                            {% set badge = status_badges.get(message.status or 'new', ('secondary', message.status)) %}
                            <span class="badge bg-{{ badge[0] }}">{{ badge[1] }}</span>
                        </td>
                        <td>
                            {% if message.risk_score is not none %}
                                {% if message.risk_score >= 80 %}
                                    <span class="badge bg-danger">Hoch ({{ message.risk_score }})</span>
                                {% elif message.risk_score >= 50 %}
                                    <span class="badge bg-warning text-dark">Mittel ({{ message.risk_score }})</span>
                                {% else %}
                                    <span class="badge bg-success">Niedrig ({{ message.risk_score }})</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-light text-muted">n/a</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ message.received_at.strftime('%d.%m.%Y %H:%M') if message.received_at else '—' }}
                        </td>
                        <td class="text-end">
                            <a href="{{ url_for('mailguard.message_detail', message_id=message.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="text-muted">
                Zeigt {{ pagination.page }} / {{ pagination.pages }}
            </div>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('mailguard.messages', page=pagination.prev_num) }}" tabindex="-1">&laquo;</a>
                    </li>
                    {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if p %}
                            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('mailguard.messages', page=p) }}">{{ p }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% endif %}
                    {% endfor %}
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('mailguard.messages', page=pagination.next_num) }}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
            <p class="text-muted mt-3">Noch keine Nachrichten gefunden</p>
            <p class="text-muted">Verbinden Sie ein Postfach oder starten Sie eine Synchronisation.</p>
        </div>
    {% endif %}
</div>
{% endblock %}
