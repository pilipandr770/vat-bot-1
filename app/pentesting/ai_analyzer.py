"""
AI-powered security analysis and recommendations.

Transforms technical security scan results into user-friendly
explanations and actionable recommendations using OpenAI.
"""

from openai import OpenAI
import json
import logging
from typing import Dict, Optional

logger = logging.getLogger(__name__)


class SecurityAnalyzer:
    """Analyze security scan results and provide AI-powered insights."""

    def __init__(self, api_key: Optional[str] = None):
        """Initialize OpenAI client."""
        self.client = OpenAI(api_key=api_key) if api_key else OpenAI()

    def analyze_results(self, scan_results: Dict, language: str = 'de') -> Dict:
        """
        Analyze security scan results and provide recommendations.
        
        Args:
            scan_results: Security scan output from WebsiteSecurityScanner
            language: Language for output ('de', 'en', etc.)
            
        Returns:
            Analysis with explanations and recommendations
        """
        try:
            # Prepare scan summary for AI analysis
            summary = self._prepare_summary(scan_results)

            # Get AI analysis
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {
                        "role": "system",
                        "content": self._get_system_prompt(language)
                    },
                    {
                        "role": "user",
                        "content": f"""Analyze the following website security scan results and provide 
                        a comprehensive but easy-to-understand explanation and recommendations:

{summary}

Please provide your response in {language} language."""
                    }
                ],
                temperature=0.7,
                max_tokens=2000
            )

            analysis_text = response.choices[0].message.content

            return {
                'status': 'success',
                'analysis': analysis_text,
                'timestamp': None,
                'model': 'gpt-3.5-turbo'
            }

        except Exception as e:
            logger.error(f"AI analysis failed: {e}")
            return {
                'status': 'error',
                'error': str(e),
                'fallback': self._generate_fallback_analysis(scan_results, language)
            }

    def _prepare_summary(self, scan_results: Dict) -> str:
        """Prepare security scan results for AI analysis."""
        summary = f"""
Website: {scan_results.get('domain', 'Unknown')}
Overall Security Score: {scan_results.get('overall_score', 0)}/100

Security Checks Results:
"""
        
        for check_name, check_result in scan_results.get('checks', {}).items():
            status = check_result.get('status', 'UNKNOWN')
            summary += f"\n{check_name.upper()}: {status}\n"
            
            if check_result.get('issues'):
                summary += "Issues:\n"
                for issue in check_result['issues']:
                    summary += f"  - {issue}\n"
            
            if check_result.get('vulnerabilities'):
                summary += "Vulnerabilities found:\n"
                for vuln in check_result['vulnerabilities']:
                    summary += f"  - {vuln}\n"

        return summary

    def _get_system_prompt(self, language: str) -> str:
        """Get system prompt for AI analysis."""
        prompts = {
            'de': """You are an expert website security analyst. Your task is to explain security 
            scan results in a way that is easy to understand for non-technical website owners and 
            small business operators.

            For each security issue found:
            1. Explain what it means in simple language
            2. Explain the risk/impact
            3. Provide specific, actionable steps to fix it
            4. Prioritize fixes by severity

            Keep explanations concise but thorough. Use analogies where helpful.
            Be encouraging - many issues can be fixed with common best practices.
            
            Respond in German (Deutsch).""",
            
            'en': """You are an expert website security analyst. Your task is to explain security 
            scan results in a way that is easy to understand for non-technical website owners and 
            small business operators.

            For each security issue found:
            1. Explain what it means in simple language
            2. Explain the risk/impact
            3. Provide specific, actionable steps to fix it
            4. Prioritize fixes by severity

            Keep explanations concise but thorough. Use analogies where helpful.
            Be encouraging - many issues can be fixed with common best practices.
            
            Respond in English."""
        }

        return prompts.get(language, prompts['en'])

    def _generate_fallback_analysis(self, scan_results: Dict, language: str) -> str:
        """Generate fallback analysis if AI is unavailable."""
        score = scan_results.get('overall_score', 0)
        
        if language == 'de':
            if score >= 80:
                return f"""
                Übersicht: Ihre Website hat eine gute Sicherheitsbewertung ({score}/100).
                
                Wichtigste Erkenntnisse:
                - Die Grundlagen sind implementiert
                - Einige Verbesserungen sind möglich
                - Regelmäßige Überprüfungen werden empfohlen
                
                Nächste Schritte:
                1. Überprüfen Sie die Ergebnisse für jede Sicherheitsfunktion
                2. Priorisieren Sie Warnungen
                3. Implementieren Sie Empfehlungen nacheinander
                """
            else:
                return f"""
                Übersicht: Ihre Website hat eine niedrigere Sicherheitsbewertung ({score}/100).
                
                Dies ist nicht ungewöhnlich. Viele Websites müssen ihre Sicherheit verbessern.
                
                Nächste Schritte:
                1. Schauen Sie sich die kritischen Probleme an
                2. Wenden Sie sich an Ihren Hosting-Provider oder Webentwickler
                3. Implementieren Sie Empfehlungen der Reihe nach
                """
        else:
            if score >= 80:
                return f"""
                Overview: Your website has a good security score ({score}/100).
                
                Key Findings:
                - Basics are in place
                - Some improvements are possible
                - Regular checks are recommended
                
                Next Steps:
                1. Review the results for each security feature
                2. Prioritize warnings
                3. Implement recommendations one by one
                """
            else:
                return f"""
                Overview: Your website has a lower security score ({score}/100).
                
                This is not unusual. Many websites need security improvements.
                
                Next Steps:
                1. Look at critical issues first
                2. Contact your hosting provider or web developer
                3. Implement recommendations step by step
                """

    def get_quick_tips(self, scan_results: Dict, language: str = 'de', max_tips: int = 5) -> list:
        """Get quick actionable tips from scan results."""
        tips = []
        issues_by_severity = self._categorize_by_severity(scan_results)

        if language == 'de':
            translations = {
                'ssl_tls': 'SSL/TLS-Sicherheit',
                'security_headers': 'Sicherheits-Header',
                'sql_injection': 'SQL-Injection',
                'xss': 'XSS-Anfälligkeit',
                'csrf': 'CSRF-Schutz',
                'open_ports': 'Offene Ports',
                'dnssec': 'DNSSEC'
            }
        else:
            translations = {
                'ssl_tls': 'SSL/TLS Security',
                'security_headers': 'Security Headers',
                'sql_injection': 'SQL Injection',
                'xss': 'XSS Vulnerability',
                'csrf': 'CSRF Protection',
                'open_ports': 'Open Ports',
                'dnssec': 'DNSSEC'
            }

        # Add critical issues as tips
        for check_name in issues_by_severity.get('critical', []):
            if len(tips) >= max_tips:
                break
            check = scan_results['checks'].get(check_name, {})
            if check.get('issues'):
                tips.append({
                    'severity': 'CRITICAL',
                    'check': translations.get(check_name, check_name),
                    'issue': check['issues'][0]
                })

        # Add high severity issues
        for check_name in issues_by_severity.get('high', []):
            if len(tips) >= max_tips:
                break
            check = scan_results['checks'].get(check_name, {})
            if check.get('issues'):
                tips.append({
                    'severity': 'HIGH',
                    'check': translations.get(check_name, check_name),
                    'issue': check['issues'][0]
                })

        return tips

    def _categorize_by_severity(self, scan_results: Dict) -> Dict[str, list]:
        """Categorize findings by severity."""
        severity_map = {
            'ssl_tls': 'critical',
            'security_headers': 'high',
            'sql_injection': 'critical',
            'xss': 'critical',
            'csrf': 'high',
            'open_ports': 'high',
            'dnssec': 'medium'
        }

        categorized = {
            'critical': [],
            'high': [],
            'medium': [],
            'low': []
        }

        for check_name, check_result in scan_results.get('checks', {}).items():
            if check_result.get('status') in ['FAILED', 'WARNING']:
                severity = severity_map.get(check_name, 'low')
                categorized[severity].append(check_name)

        return categorized
