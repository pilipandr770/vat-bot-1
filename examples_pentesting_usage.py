"""
Examples of using the Website Security Scanner API

These examples show how to integrate the pentesting module
into your application, tests, or custom workflows.
"""

from app.pentesting.security_scanner import WebsiteSecurityScanner
from app.pentesting.ai_analyzer import SecurityAnalyzer
from app import create_app, db
from app.auth.models import User
from datetime import datetime
import json

app = create_app()


# ============================================================================
# EXAMPLE 1: Basic Website Scan
# ============================================================================

def example_basic_scan():
    """Scan a website and get security score."""
    
    scanner = WebsiteSecurityScanner(timeout=10)
    results = scanner.scan_website('example.com')
    
    print(f"Domain: {results['domain']}")
    print(f"Security Score: {results['overall_score']}/100")
    print(f"Risk Level: {scanner.get_risk_level(results['overall_score'])}")
    
    # Show each check result
    for check_name, check_result in results['checks'].items():
        print(f"\n{check_name.upper()}: {check_result['status']}")
        if check_result.get('issues'):
            for issue in check_result['issues']:
                print(f"  - {issue}")


# ============================================================================
# EXAMPLE 2: AI-Powered Analysis
# ============================================================================

def example_ai_analysis():
    """Scan and analyze with OpenAI."""
    
    scanner = WebsiteSecurityScanner()
    results = scanner.scan_website('example.com')
    
    # Get AI analysis
    analyzer = SecurityAnalyzer()
    analysis = analyzer.analyze_results(results, language='de')
    
    if analysis['status'] == 'success':
        print("=" * 60)
        print("AI-Powered Security Analysis")
        print("=" * 60)
        print(analysis['analysis'])
    else:
        print(f"Analysis failed: {analysis.get('error')}")
        print(f"Fallback: {analysis.get('fallback')}")


# ============================================================================
# EXAMPLE 3: Quick Tips
# ============================================================================

def example_quick_tips():
    """Get quick actionable tips."""
    
    scanner = WebsiteSecurityScanner()
    results = scanner.scan_website('example.com')
    
    analyzer = SecurityAnalyzer()
    tips = analyzer.get_quick_tips(results, language='de', max_tips=5)
    
    print(f"Top {len(tips)} Issues to Fix:")
    for i, tip in enumerate(tips, 1):
        print(f"{i}. [{tip['severity']}] {tip['check']}")
        print(f"   {tip['issue']}")
        print()


# ============================================================================
# EXAMPLE 4: Full Report with Database Logging
# ============================================================================

def example_full_report_with_logging(user_id: int, url: str):
    """Scan and log results to database."""
    from app.pentesting.models import PentestingLog
    
    with app.app_context():
        # Get user
        user = User.query.get(user_id)
        if not user:
            print("User not found")
            return
        
        # Check if user has subscription
        if not user.active_subscription or user.active_subscription.plan == 'free':
            print("User doesn't have access to pentesting")
            return
        
        # Perform scan
        print(f"Scanning {url}...")
        scanner = WebsiteSecurityScanner()
        results = scanner.scan_website(url)
        
        # Get AI analysis
        print("Getting AI analysis...")
        analyzer = SecurityAnalyzer()
        analysis = analyzer.analyze_results(results, language='de')
        
        # Save to database
        log = PentestingLog(
            user_id=user_id,
            domain=url.split('//')[1].split('/')[0] if '//' in url else url,
            action='scan',
            security_score=results['overall_score'],
            findings_count=sum(1 for check in results['checks'].values() 
                             if check.get('issues')),
            findings_data=results,
            ai_analysis=analysis.get('analysis', ''),
            created_at=datetime.utcnow()
        )
        db.session.add(log)
        db.session.commit()
        
        print(f"Scan complete! Score: {results['overall_score']}/100")
        print(f"Report saved to database (ID: {log.id})")
        
        return log


# ============================================================================
# EXAMPLE 5: Batch Scanning
# ============================================================================

def example_batch_scan(urls: list) -> dict:
    """Scan multiple websites."""
    
    results = {}
    scanner = WebsiteSecurityScanner()
    
    for url in urls:
        print(f"Scanning {url}...")
        try:
            result = scanner.scan_website(url)
            results[url] = {
                'score': result['overall_score'],
                'risk': scanner.get_risk_level(result['overall_score']),
                'checks': {
                    name: check['status'] 
                    for name, check in result['checks'].items()
                }
            }
        except Exception as e:
            results[url] = {'error': str(e)}
    
    # Print summary
    print("\n" + "=" * 60)
    print("BATCH SCAN SUMMARY")
    print("=" * 60)
    for url, result in results.items():
        if 'error' in result:
            print(f"{url}: ERROR - {result['error']}")
        else:
            print(f"{url}: {result['score']}/100 ({result['risk']})")
    
    return results


# ============================================================================
# EXAMPLE 6: Individual Security Checks
# ============================================================================

def example_individual_checks(url: str):
    """Run individual security checks."""
    
    scanner = WebsiteSecurityScanner()
    
    print("SSL/TLS Check:")
    domain = url.split('//')[1].split('/')[0] if '//' in url else url
    ssl_result = scanner._check_ssl_tls(domain)
    print(f"  Status: {ssl_result['status']}")
    print(f"  TLS Version: {ssl_result['details'].get('tls_version', 'Unknown')}")
    
    print("\nSecurity Headers Check:")
    headers_result = scanner._check_security_headers(url)
    print(f"  Status: {headers_result['status']}")
    print(f"  Found: {len(headers_result.get('present_headers', {}))} headers")
    print(f"  Missing: {len(headers_result.get('missing_headers', []))} headers")
    
    print("\nOpen Ports Check:")
    ports_result = scanner._check_open_ports(domain)
    print(f"  Status: {ports_result['status']}")
    print(f"  Open Ports: {len(ports_result.get('open_ports', []))}")
    for port_info in ports_result.get('open_ports', []):
        print(f"    - {port_info['port']} ({port_info['service']})")
    
    print("\nSQL Injection Check:")
    sql_result = scanner._check_sql_injection(url)
    print(f"  Status: {sql_result['status']}")
    print(f"  Vulnerabilities found: {len(sql_result.get('vulnerabilities', []))}")
    
    print("\nXSS Check:")
    xss_result = scanner._check_xss(url)
    print(f"  Status: {xss_result['status']}")
    print(f"  Vulnerabilities found: {len(xss_result.get('vulnerabilities', []))}")
    
    print("\nCSRF Check:")
    csrf_result = scanner._check_csrf(url)
    print(f"  Status: {csrf_result['status']}")
    print(f"  Has CSRF Token: {csrf_result.get('has_csrf_token', False)}")
    
    print("\nDNSSEC Check:")
    dnssec_result = scanner._check_dnssec(domain)
    print(f"  Status: {dnssec_result['status']}")
    print(f"  DNSSEC Enabled: {dnssec_result.get('dnssec_enabled', False)}")


# ============================================================================
# EXAMPLE 7: Export Scan Results to JSON
# ============================================================================

def example_export_results(url: str, filename: str = None):
    """Scan and export results to JSON."""
    
    if filename is None:
        domain = url.split('//')[1].split('/')[0] if '//' in url else url
        filename = f"security-report-{domain}-{datetime.now().strftime('%Y%m%d-%H%M%S')}.json"
    
    scanner = WebsiteSecurityScanner()
    results = scanner.scan_website(url)
    
    # Add AI analysis
    analyzer = SecurityAnalyzer()
    analysis = analyzer.analyze_results(results, language='de')
    
    # Prepare export
    export_data = {
        'scan_date': datetime.utcnow().isoformat(),
        'domain': results['domain'],
        'security_score': results['overall_score'],
        'risk_level': scanner.get_risk_level(results['overall_score']),
        'checks': results['checks'],
        'ai_analysis': analysis.get('analysis', ''),
        'quick_tips': analyzer.get_quick_tips(results, language='de')
    }
    
    # Save to file
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(export_data, f, indent=2, ensure_ascii=False)
    
    print(f"Report exported to: {filename}")
    return filename


# ============================================================================
# EXAMPLE 8: Monitor Scans per User
# ============================================================================

def example_monitor_user_scans(user_id: int):
    """Get user's scan history and statistics."""
    from app.pentesting.models import PentestingLog
    from sqlalchemy import func
    
    with app.app_context():
        user = User.query.get(user_id)
        if not user:
            print("User not found")
            return
        
        # Get all scans
        scans = PentestingLog.query.filter_by(user_id=user_id).all()
        
        print(f"User: {user.email}")
        print(f"Plan: {user.subscription_plan.upper()}")
        print(f"Total Scans: {len(scans)}")
        
        if scans:
            # Statistics
            avg_score = sum(s.security_score for s in scans) / len(scans)
            critical_count = sum(1 for s in scans if s.security_score < 40)
            
            print(f"Average Score: {avg_score:.1f}/100")
            print(f"Critical Issues: {critical_count}")
            
            # Recent scans
            print("\nRecent Scans:")
            for scan in scans[-5:]:
                print(f"  - {scan.domain}: {scan.security_score}/100 ({scan.risk_level}) - {scan.created_at.strftime('%Y-%m-%d %H:%M')}")


# ============================================================================
# EXAMPLE 9: Integration with Dashboard
# ============================================================================

def example_dashboard_widget():
    """Generate data for dashboard widget."""
    from app.pentesting.models import PentestingLog
    from sqlalchemy import func
    from datetime import datetime, timedelta
    
    with app.app_context():
        # Get statistics for dashboard
        today = datetime.utcnow() - timedelta(days=1)
        
        total_scans = PentestingLog.query.count()
        scans_today = PentestingLog.query.filter(
            PentestingLog.created_at >= today
        ).count()
        
        avg_score = db.session.query(
            func.avg(PentestingLog.security_score)
        ).scalar() or 0
        
        # Find most common vulnerability
        checks = [c for scan in PentestingLog.query.all() 
                 for c in scan.findings_data.get('checks', {})
                 if scan.findings_data]
        
        widget_data = {
            'total_scans': total_scans,
            'scans_today': scans_today,
            'average_score': round(avg_score, 1),
            'widget_title': 'ðŸ›¡ï¸ Security Scanner Activity',
            'metric': f'{scans_today} scans today'
        }
        
        return widget_data


# ============================================================================
# EXAMPLE 10: Compliance Report
# ============================================================================

def example_compliance_report(min_score: int = 70) -> dict:
    """Generate compliance report for all users."""
    from app.pentesting.models import PentestingLog
    from sqlalchemy import func
    
    with app.app_context():
        # Find websites below minimum score
        low_score_scans = PentestingLog.query.filter(
            PentestingLog.security_score < min_score
        ).all()
        
        # Group by user
        by_user = {}
        for scan in low_score_scans:
            if scan.user_id not in by_user:
                by_user[scan.user_id] = []
            by_user[scan.user_id].append(scan)
        
        # Generate report
        report = {
            'threshold': f'{min_score}/100',
            'total_violations': len(low_score_scans),
            'affected_users': len(by_user),
            'details': {}
        }
        
        for user_id, scans in by_user.items():
            user = User.query.get(user_id)
            report['details'][user.email] = [
                {
                    'domain': s.domain,
                    'score': s.security_score,
                    'risk_level': s.risk_level,
                    'date': s.created_at.isoformat()
                }
                for s in scans
            ]
        
        return report


# ============================================================================
# Running Examples
# ============================================================================

if __name__ == '__main__':
    print("Website Security Scanner - Usage Examples\n")
    
    # Choose which example to run:
    
    # 1. Basic scan
    # example_basic_scan()
    
    # 2. AI analysis
    # example_ai_analysis()
    
    # 3. Quick tips
    # example_quick_tips()
    
    # 4. Individual checks
    # example_individual_checks('https://example.com')
    
    # 5. Export results
    # example_export_results('https://example.com')
    
    # 6. Batch scanning
    # urls = ['example.com', 'google.com', 'github.com']
    # example_batch_scan(urls)
    
    # 7. Dashboard widget
    # widget = example_dashboard_widget()
    # print(json.dumps(widget, indent=2))
    
    print("See this file for examples of how to use the security scanner.")
