# Website Security Scanner (Pentesting Module) - Integration Guide

## üìã Overview

The pentesting module provides comprehensive website security scanning capabilities for detecting vulnerabilities such as:

- **SSL/TLS Configuration** - Certificate validity, TLS version, cipher strength
- **Security Headers** - HSTS, X-Frame-Options, CSP, X-Content-Type-Options
- **SQL Injection** - Parameter injection testing
- **XSS (Cross-Site Scripting)** - Reflected XSS detection
- **CSRF Protection** - CSRF token verification
- **Open Ports** - Identification of exposed services
- **DNSSEC** - DNS security validation

All checks are **safe and non-destructive** - no data is extracted or modified.

## üöÄ Installation & Integration Steps

### Step 1: Update requirements.txt

Add the following dependencies to your `requirements.txt`:

```
dnspython>=2.4.0
requests>=2.31.0
```

Then install:
```bash
pip install -r requirements.txt
```

### Step 2: Update Application Configuration (application.py)

Add the pentesting blueprint registration. Find the section where other blueprints are registered (around line 140):

```python
# Register Pentesting blueprint
from app.pentesting.routes import pentesting
app.register_blueprint(pentesting, url_prefix='/api/pentesting')
```

Add this **before** the scheduler initialization section.

### Step 3: Create Database Migration for Pentesting Tables

Create a new migration file:

```bash
flask db migrate -m "Add pentesting module tables"
```

The migration will auto-detect the new models in `app/pentesting/models.py`:
- `PentestingLog` - Stores scan history
- `PentestingSubscriptionQuota` - Tracks API usage per subscription

Run the migration:

```bash
flask db upgrade
```

### Step 4: Add Scanner UI Route

Add a route to serve the scanner HTML. In `application.py`, add:

```python
@app.route('/pentesting-scanner')
@login_required
def pentesting_scanner():
    """Serve website security scanner."""
    return render_template('pentesting/scanner.html')
```

### Step 5: Update Navigation

Add link to scanner in your navigation template:

```html
{% if current_user.is_authenticated and (current_user.is_admin or (current_user.active_subscription and current_user.active_subscription.plan in ['pro', 'enterprise'])) %}
    <a href="{{ url_for('pentesting_scanner') }}" class="nav-link">
        üõ°Ô∏è Security Scanner
    </a>
{% endif %}
```

## üìä API Endpoints

### 1. Full Website Scan

**POST** `/api/pentesting/scan`

Request:
```json
{
    "url": "example.com",
    "include_ai_analysis": true,
    "language": "de"
}
```

Response:
```json
{
    "status": "success",
    "scan_results": {
        "url": "https://example.com",
        "domain": "example.com",
        "overall_score": 75,
        "checks": {
            "ssl_tls": {
                "status": "PASSED",
                "issues": [],
                "details": {...}
            },
            ...
        }
    },
    "ai_analysis": {
        "status": "success",
        "analysis": "Human-readable security analysis..."
    },
    "timestamp": "2024-01-16T10:30:00Z"
}
```

### 2. Quick Scan

**POST** `/api/pentesting/quick-scan`

Faster scan with top issues only.

Request:
```json
{
    "url": "example.com",
    "language": "de"
}
```

Response:
```json
{
    "status": "success",
    "security_score": 75,
    "risk_level": "MEDIUM",
    "top_issues": [
        {
            "severity": "CRITICAL",
            "check": "SSL/TLS Security",
            "issue": "Issue description..."
        }
    ]
}
```

### 3. Scan History

**GET** `/api/pentesting/reports?limit=20&offset=0`

Get user's scan history.

### 4. Detailed Report

**GET** `/api/pentesting/report/<scan_id>`

Get full report for a specific scan.

### 5. API Status

**GET** `/api/pentesting/status`

Check if pentesting is available for user and remaining quota.

## üîê Access Control

Pentesting is available for:
- ‚úÖ **Admin users** - Unlimited access
- ‚úÖ **PRO users** - 50 scans per day
- ‚úÖ **ENTERPRISE users** - Unlimited scans
- ‚ùå **FREE users** - No access

Access control is enforced via `@require_subscription` decorator on all endpoints.

## üí∞ Rate Limiting

Implemented per subscription tier:

| Plan | Daily Scans | AI Analyses | Monthly Cost |
|------|------------|------------|--------------|
| FREE | 0 | 0 | ‚Ç¨0 |
| PRO | 50 | Unlimited | ‚Ç¨49.99 |
| ENTERPRISE | 1000 | Unlimited | ‚Ç¨199.99 |

Rate limiting checks:
```python
def _check_rate_limit(user_id: int, action: str) -> bool:
    # Counts scans in last 24 hours
    # Compares against subscription plan limit
    # Returns True if within limit
```

## ü§ñ AI-Powered Analysis

When `include_ai_analysis=true`, results are analyzed by OpenAI (GPT-3.5-turbo):

- **Translations**: Results explained in user's language (de, en, etc.)
- **Explanations**: What each vulnerability means in simple terms
- **Recommendations**: Step-by-step fix instructions
- **Prioritization**: Critical issues highlighted first

The AI prompt is customized based on language:
```python
analyzer = SecurityAnalyzer(api_key=app.config['OPENAI_API_KEY'])
analysis = analyzer.analyze_results(scan_results, language='de')
```

**Cost**: ~$0.002-0.01 per scan (depends on vulnerability count)

## üìù Logging & Audit Trail

All scans are logged in `pentesting_logs` table:

```python
{
    'user_id': 123,
    'domain': 'example.com',
    'security_score': 75,
    'findings_count': 3,
    'findings_data': {...},  # Full results JSON
    'ai_analysis': '...',    # Analysis text
    'created_at': '2024-01-16T10:30:00Z'
}
```

Query example:
```python
from app.pentesting.models import PentestingLog

# Get user's recent scans
scans = PentestingLog.query\
    .filter_by(user_id=current_user.id)\
    .order_by(PentestingLog.created_at.desc())\
    .limit(10)\
    .all()
```

## üß™ Testing

### Manual API Testing

```bash
# Full scan with AI analysis
curl -X POST http://localhost:5000/api/pentesting/scan \
  -H "Content-Type: application/json" \
  -H "Cookie: session=YOUR_SESSION_ID" \
  -d '{
    "url": "example.com",
    "include_ai_analysis": true,
    "language": "de"
  }'

# Quick scan
curl -X POST http://localhost:5000/api/pentesting/quick-scan \
  -H "Content-Type: application/json" \
  -H "Cookie: session=YOUR_SESSION_ID" \
  -d '{"url": "example.com"}'

# Check status
curl http://localhost:5000/api/pentesting/status \
  -H "Cookie: session=YOUR_SESSION_ID"
```

### Unit Testing

Create `tests/test_pentesting.py`:

```python
def test_ssl_check():
    scanner = WebsiteSecurityScanner()
    result = scanner._check_ssl_tls('example.com')
    assert 'tls_version' in result['details']
    assert result['status'] in ['PASSED', 'WARNING', 'FAILED']

def test_security_headers():
    scanner = WebsiteSecurityScanner()
    result = scanner._check_security_headers('https://example.com')
    assert 'missing_headers' in result
    assert 'present_headers' in result

def test_sql_injection():
    scanner = WebsiteSecurityScanner()
    result = scanner._check_sql_injection('https://example.com')
    assert result['details']['safe_test'] == True
```

## üöÄ Deployment to Render

### 1. Add Environment Variables

In Render.com dashboard ‚Üí Settings ‚Üí Environment Variables:

```
OPENAI_API_KEY=sk-...  # For AI analysis
```

### 2. Run Migrations

In Render ‚Üí Shell:
```bash
flask db upgrade
```

### 3. Restart Application

Render will auto-detect changes and restart.

## üìà Monitoring & Analytics

### Dashboard Metrics

Add to admin dashboard:

```python
@admin_bp.route('/analytics/pentesting')
def pentesting_analytics():
    from app.pentesting.models import PentestingLog
    
    stats = {
        'total_scans': PentestingLog.query.count(),
        'scans_today': PentestingLog.query.filter(
            PentestingLog.created_at >= datetime.utcnow() - timedelta(days=1)
        ).count(),
        'avg_score': db.session.query(func.avg(PentestingLog.security_score)).scalar(),
        'vulnerabilities_found': PentestingLog.query.filter(
            PentestingLog.security_score < 60
        ).count()
    }
    return jsonify(stats)
```

## üîí Security Considerations

### Safe Testing

‚úÖ **All checks are safe**:
- No data extraction
- No files are downloaded
- No database queries are executed
- Request timeouts prevent hanging
- No brute force attempts

### Rate Limiting

‚úÖ **Protected against abuse**:
- Per-user daily limits
- Subscription-based quotas
- 10-second request timeout

### Data Privacy

‚úÖ **Minimal data collection**:
- Only domain + scan results stored
- No user cookies or secrets captured
- Results logged only for audit trail
- Can be deleted on user request

## üìö Architecture

```
app/pentesting/
‚îú‚îÄ‚îÄ __init__.py              # Module initialization
‚îú‚îÄ‚îÄ security_scanner.py      # Core scanning logic
‚îú‚îÄ‚îÄ ai_analyzer.py           # OpenAI integration
‚îú‚îÄ‚îÄ routes.py                # API endpoints
‚îî‚îÄ‚îÄ models.py                # Database models

templates/pentesting/
‚îî‚îÄ‚îÄ scanner.html             # Web UI
```

## ü§ù Integration Examples

### Add to Dashboard

```python
# In dashboard.html
{% if current_user.active_subscription and current_user.active_subscription.plan in ['pro', 'enterprise'] %}
    <div class="widget">
        <h3>Website Security Scanner</h3>
        <p>Check your website for vulnerabilities</p>
        <a href="{{ url_for('pentesting_scanner') }}" class="btn">Start Scan</a>
    </div>
{% endif %}
```

### Programmatic Usage

```python
from app.pentesting.security_scanner import WebsiteSecurityScanner
from app.pentesting.ai_analyzer import SecurityAnalyzer

# Scan website
scanner = WebsiteSecurityScanner()
results = scanner.scan_website('example.com')

# Analyze with AI
analyzer = SecurityAnalyzer(api_key=current_app.config['OPENAI_API_KEY'])
analysis = analyzer.analyze_results(results, language='de')

# Use results
print(f"Score: {results['overall_score']}")
print(f"Risk: {scanner.get_risk_level(results['overall_score'])}")
print(f"Analysis: {analysis['analysis']}")
```

## üêõ Troubleshooting

### Import Errors

If you get import errors, ensure:
1. `dnspython` is installed: `pip install dnspython`
2. `__init__.py` exists in `app/pentesting/`
3. Blueprint is registered in `application.py`

### Database Errors

If migrations fail:
```bash
# Drop table and re-migrate
flask db downgrade
flask db upgrade
```

### API Timeouts

If scans timeout on slow networks:
```python
# Increase timeout in security_scanner.py
scanner = WebsiteSecurityScanner(timeout=20)  # 20 seconds
```

### AI Analysis Errors

If OpenAI fails:
```python
# Check API key
echo $OPENAI_API_KEY

# Fallback analysis is provided automatically
# Check analyzer.py _generate_fallback_analysis()
```

## üìû Support & Questions

For issues or questions:
1. Check logs: `flask logs` (on Render)
2. Test endpoint: `GET /api/pentesting/status`
3. Review security_scanner.py for detailed error messages

---

**Version**: 1.0  
**Last Updated**: January 16, 2024  
**Status**: Production Ready
